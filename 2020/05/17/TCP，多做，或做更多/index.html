<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="google-site-verification" content="" />
  
  <title>TCP，多做，或做更多</title>
  <meta name="author" content="ZouKaihua">
  <meta name="description" content="邹凯华的写字板，技术，心情分享^_^">
  
  
  <meta property="og:title" content="TCP，多做，或做更多"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:site_name" content="ZouKaihua&#39;s Writing Board"/>
  <link href="/apple-touch-icon-precomposed.png" sizes="180x180" rel="apple-touch-icon-precomposed">
  <link rel="alternate" href="/atom.xml" title="ZouKaihua&#39;s Writing Board" type="application/atom+xml">
  <link rel="stylesheet" href="/css/m.min.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <a id="top"></a>
  <div id="main">
    <div class="main-ctnr">
      <div class="behind">
  <a href="/" class="back black-color">
    <svg class="i-close" viewBox="0 0 32 32" width="22" height="22" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3">
        <path d="M2 30 L30 2 M30 30 L2 2"></path>
    </svg>
  </a>
  <div class="description">
    &nbsp;
  </div>
</div>


  <article class="standard post">
    <div class="title">
      
  
    <h1 class="page-title center">
        TCP，多做，或做更多
    </h1>
  


    </div>
    <div class="meta center">
      <time datetime="2020-05-17T04:28:11.000Z" itemprop="datePublished">
  <svg class="i-calendar" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
    <path d="M2 6 L2 30 30 30 30 6 Z M2 15 L30 15 M7 3 L7 9 M13 3 L13 9 M19 3 L19 9 M25 3 L25 9"></path>
  </svg>
  &nbsp;
  2020-05-17
</time>


    
    &nbsp;
    <svg class="i-tag" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
      <circle cx="24" cy="8" r="2"></circle>
      <path d="M2 18 L18 2 30 2 30 14 14 30 Z"></path>
    </svg>
    &nbsp;
    <a href="/categories/网络/">网络</a>




    
    &nbsp;
    <svg class="i-tag" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
      <circle cx="24" cy="8" r="2"></circle>
      <path d="M2 18 L18 2 30 2 30 14 14 30 Z"></path>
    </svg>
    &nbsp;
    <a href="/tags/传输层/">传输层</a>·<a href="/tags/TCP/">TCP</a>


    </div>
    <hr>
    
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#特点"><span class="toc-text">特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#组成"><span class="toc-text">组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三次握手"><span class="toc-text">三次握手</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四次挥手"><span class="toc-text">四次挥手</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#可靠传输实现"><span class="toc-text">可靠传输实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#效率传输方法"><span class="toc-text">效率传输方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拥塞控制"><span class="toc-text">拥塞控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#个人觉得的问题"><span class="toc-text">个人觉得的问题</span></a></li></ol>
    
    <div class="picture-container">
      
    </div>
    <p>TCP，传输控制协议，是传输层重要成员之一。我觉得它，能少做，那就多做，能多做，就做更做，多多益善。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>1，传输数据需要连接，只能单点连接。</p>
<p>2，进行传输，确保可靠到达。</p>
<p>3，面向字节流，传输的是切割后重组的报文段。</p>
<p>4，开销较大，首部二十个字节，SYN-ACK模式。</p>
<h2 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h2><p><img src="/imgs/2020/05/16/TCP%EF%BC%8C%E5%A4%9A%E5%81%9A%EF%BC%8C%E6%88%96%E5%81%9A%E6%9B%B4%E5%A4%9A/TCP%E6%8A%A5%E6%96%87%E6%AE%B5%E7%BB%84%E6%88%90.png" alt="img"><br>由首部字段和数据字段这两部分组成，首部字段只占20个字节，其中首部字段包括字段较多，解释一下。</p>
<p>源端口和目标端口：通信入口，各占2字节；</p>
<p>序号：传输报文段中字节流序列的第一个字节编号，占4字节；</p>
<p>确认号：下一次传输报文段中字节流序列的第一个字节编号，等于序号+1，占4字节；</p>
<p>数据偏移：计算首部字段长度值，占4位；</p>
<p>保留：全0，占6位；</p>
<p>URG：紧急指针状态，为1，表示有效，优先传输，占1位；</p>
<p>ACK：确认号，连接建立前为接收SYN+1，连接建立后置1，占1位；</p>
<p>PSH：推送状态，为1时，接收端将提前向应用层交付报文段，不用排队重组后再交付，占1位；</p>
<p>RST：复位标识，为1时，表示连接出现问题，需要重建连接，占1位；</p>
<p>SYN：连接建立时同步序号，为1表示报文段属于连接请求或接受请求的报文段，占1位；</p>
<p>FIN：为1表示连接终止，占1位；</p>
<p>窗口：这个表明接收端或发送端，在接收另一端的数据时，从确认号开始，所能接受的最大数据量，占16位；</p>
<p>检验和：伪首部，参考UDP伪首部，TCP协议字段对应值为6，UDP长度改为TCP长度；</p>
<p>紧急指针：URG为1时作用，表示紧急数据在报文段的末端位置，紧急数据处理完毕，恢复排队等候操作；</p>
<p>选项：长度可变，最大40字节，里面包括MSS，数据字段的最大长度，加上首部字段等于报文段长度；</p>
<p>填充：在这只是让表格尽可能完整，不具有逻辑含义。</p>
<h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p><img src="/imgs/2020/05/16/TCP%EF%BC%8C%E5%A4%9A%E5%81%9A%EF%BC%8C%E6%88%96%E5%81%9A%E6%9B%B4%E5%A4%9A/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.jpg" alt="img"></p>
<h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p><img src="/imgs/2020/05/16/TCP%EF%BC%8C%E5%A4%9A%E5%81%9A%EF%BC%8C%E6%88%96%E5%81%9A%E6%9B%B4%E5%A4%9A/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpg" alt="img"></p>
<h2 id="可靠传输实现"><a href="#可靠传输实现" class="headerlink" title="可靠传输实现"></a>可靠传输实现</h2><p>这里我觉得应该分两块来说这个问题，即理论描述和落地实现。</p>
<p>理论描述：</p>
<p>发送端在发送报文段后，需要等待接收端收到正常报文段的回复，超时发送端则重传该报文段。接收端检验和出错，则丢弃制造超时，等待发送端重传。这个理论逻辑贯穿整个传输生命周期，包括连接建立，数据请求和响应，以及连接终止。</p>
<p>落地实现：</p>
<p>实现过程分阶段，从低效传输到高效传输，但至始至终，都需保证可靠交付。</p>
<p>一、简单ARQ</p>
<p>自动重传请求（发送端主动重传响应数据），即传输一次报文段后便停止等待恢复，导致信道传输效率较低。</p>
<p>二、简单滑动窗口</p>
<p>即一次发送多个连续报文段，等待回复，以接收端所接受到的最后一个报文段为准，如果接受端接受的最后一个报文不是发送端的最后一个报文，那么，发送端会重发所有可能传输丢失的其他报文段。</p>
<p>正常情况，报文段确实丢失，选择重发，等待下一次回复；但是，信道延迟、网络拥塞以及吞吐能力下降，将可能导致接收端回复超时，重传将导致情况恶化。</p>
<p>三、动态滑动窗口</p>
<p>滑动窗口引入窗口大小动态控制机制，双方根据信道、网络以及吞吐能力设置合理窗口大小，取二者中的较小值，这个值就是窗口探测值，会放到首部字段的 选项 中，进行流量控制，这个机制也是贯穿整个传输生命周期的。</p>
<h2 id="效率传输方法"><a href="#效率传输方法" class="headerlink" title="效率传输方法"></a>效率传输方法</h2><p>一、Nagle算法</p>
<p>该算法的主要逻辑是，如果数据字段数据很少，将延迟发送，下面两个条件都不满足，将会延缓发送端数据传输。</p>
<ol>
<li>已发送数据都已经确认收到回复；</li>
<li>发送报文段达到MSS</li>
</ol>
<p>二、延迟确认应答</p>
<p>接收端吞吐能力较低时，每次接收处理数据很少，累积处理结果，延迟回复</p>
<p>三、捎带应答</p>
<p>这个地方是结合应用层来说，应用层在接受消息后一般需要做出回应，那么，可以等待回应生成数据后，一起回复确认，也将减少回复频率提高信道利用率，但这必须结合延迟确认应答处理机制。</p>
<h2 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h2><p>其实，我觉得拥塞控制很大程度，其实属于效率传输部分，但还是想把它单独拎出来。</p>
<p>一般用来进行拥塞控制的方法有四种：慢启动、拥塞避免、快重传和快恢复。</p>
<p>慢启动可以说是基于滑动窗口的，所以慢启动和流量控制还是有关系的，我觉得慢启动是一个过程，流量控制是一个结果，而每个过程中都会有一个临时的流量控制结果。</p>
<p>慢启动机制下，发送端会初始化一个拥塞窗口，写入到首部字段 选项 中，然后传输数据，同样接收端在恢复后也将调整自己的窗口大小。</p>
<p>一轮下来，将出现不同情况：</p>
<p>如果未出现网络拥塞或者超时回复。发送端在之前拥塞窗口的大小基础上加倍，继续指数增长；</p>
<p>如果出现网络拥塞或者超时回复，发送端将会对拥塞窗口大小减半，得到一个慢启动阈值；同时初始化拥塞窗口，当拥塞窗口达到慢启动阈值后，以慢启动阈值+3个报文段的拥塞窗口大小，进行线性增长。这种机制的转变，是拥塞避免、快重传和快恢复的三者结合。</p>
<p>快重传规定，发送端一连收到3个重复回复确认（共4次），即认为接收端没有收到重复数据的后一个数据，将立即进行重传，这样发送端就不会因为回复超时以为网络拥塞，重新初始化拥塞窗口，继续上面的操作，从而提高信道传输效率。</p>
<h2 id="个人觉得的问题"><a href="#个人觉得的问题" class="headerlink" title="个人觉得的问题"></a>个人觉得的问题</h2><p>问题1：TCP创建连接为什么不是 请求-应答 总共两次？</p>
<p>主要是防止延迟或者超时问题，如果在规定时间内，请求端没有获得回复，将重发请求。可超时到达的请求仍将创建一个新的连接，但是请求端却因为已经新发起连接请求，而将超时请求丢弃，导致资源浪费。所以，需要请求端做最后回复确认，才算建立连接。</p>
<p>问题2：TCP终止连接为什么需要四次？</p>
<p>主要是服务端这边，上一次接受请求的数据可能还没有传输完毕，但先进行回复断开连接请求，以便请求端能进入下一个等待状态。</p>
<p>问题3：为什么请求端发出最后回复后，还需要等待2MSL？</p>
<p>MSL，最长报文生命。2MSL，就是发出的请求得到回复的最长报文生命和。</p>
<p>请求端最后发送的断开连接回复报文段，可能丢失，而超时将导致服务端重发报文段，服务端无法正常进入关闭连接状态。同时，连接内包括延时中的请求报文都有足够长的时间，在网络中消失。</p>
<p>问题4：为什么不是接收端主动提交自己的实际网络吞吐能力，需要发送端做尝试性操作？</p>
<p>问题5：拥塞窗口减半后，为什么不直接以慢启动阈值+3个报文段，这种方式进行下一次传输？</p>
<p>我觉得问题4和问题5可能是同一个问题，主要可能是因为网速或者带宽的问题，一般请求端的网速可能处于共享状态，波动性较大；如果恶意请求端伪造吞吐能力，将极大耗费服务端资源，也将造成网络拥堵，消耗网络资源；至于为什么是重新初始化拥塞窗口，而不是直接使用慢启动阈值+3个报文段这种方式进行，我觉得是用时间换空间的操作，尽可能不发生网络拥堵，毕竟网络资源已经遇到瓶颈了，而且价格不便宜。</p>


  </article>
  <!--</script> bug oops-->
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <div class="busuanzi center">
    <!--页阅读量:&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;・&nbsp;
    站访问量:&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;・&nbsp;
    站访客数:&nbsp;<span id="busuanzi_value_site_uv"></span>-->
  </div>


    





    </div>
  </div>
  <footer class="page-footer"><div class="clearfix">
</div>
<div class="right-foot">
    <div class="firstrow">
        <a href="#top" target="_self">
        <svg class="i-caret-right" viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3">
            <path d="M10 30 L26 16 10 2 Z"></path>
        </svg>
        </a>
        ©ZouKaihua 2020
    </div>
    <div class="secondrow">
        <a href="https://blog.zoukaihua.com" target="_blank" rel="noopener">
        
        </a>
    </div>
</div>
<div class="clearfix">
</div>
</footer>
  <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<script type="text/javascript">

// disqus scripts


// dropdown scripts
$(".dropdown").click(function(event) {
  var current = $(this);
  event.stopPropagation();
  $(current).children(".dropdown-content")[($(current).children(".dropdown-content").hasClass("open"))?'removeClass':'addClass']("open")
});
$(document).click(function(){
    $(".dropdown-content").removeClass("open");
})


</script>

</body>
</html>
